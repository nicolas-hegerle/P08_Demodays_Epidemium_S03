# Epidemium season 3: ORL/IA
### Predicting the evolution of Papillomavirus-induced ENT cancer from pathology sections of tumor

## Objectives:

Based on pathology (tumor section/slides) data from HPV-induced orophrayngeal cancers we set out to predict the Overall Survival of patients suffering from HPV induced ORl cancer

## Method:

To achieve our goal we first used image data and Deep Learning Convnets or Transfer Learning with Tensorflow Keras Applications Inceptionv3, InceptionResNetv2 and DenseNet201 to try predict overall survival of patients which is the time of survival in months post diagnosis.

## Available files and notebooks

### <ins>Notebooks</ins>

* P08_Epidemium_EDA.ipynb:

    - Exploratory Data Analysis of the data provided for this project.

* P08_Raw_Data_prep.ipynb:
    - Code used to process the raw data into data usable for model training
        - split images into train and test sets
        - generate pandas dataframes used for tensorflow image generators
        - generate 'blue' and 'red' images from the raw image data

* P08_Epidemium_TF_TL_Model_Training.ipynb:
    - model training
    - Convnet model obtained from ```Liimatainen et al, Biomolecules 2021, 11, 264. https://doi.org/10.3390/biom11020264``` and only trained as base model
    - Inceptionv3, InceptionResNetv2 and DenseNet201 available in Keras Applications 
    - base models = models for which only the prediction layer is trained
    - 20pct = models for which 20% of the mayers were freed for trainind
 * P08_Summary.ipynb:
    - Computes best model based on MAE and Generates summary graphs and stats from model training. See ```Image legend``` section for graph explanation

### <ins>Python scripts</ins>

* graph_func.py:

    - function to generate the summary graphs of trained models using generated predictions

 * train_func.py:

    - functions used for model training:
        * ```create_imgen```: instantiates the flow from dataframe image generators 
        * ```create_model```: instantiates the model 
        * ```create_callback```: instantiates checkpoint and tensorboard callbacks
        * ```train_model```: compiles, fits and reloads the best model
        * ```generate_predictions```: uses the given model to generate prediction over n batches of image generators
        * ```convnet```: instaciates the Convent sequential model
    
### <ins>src directory</ins>

* pred_df:

    - predictions generated using the ```generate_predictions``` function for all trained models

* pred_graphs:

    - graphical summary of the predicted os and MAE for generated on the train and validation image sets for each trained model

* tf_logs:

    - tensorboard logs for each model

### <ins>png directory</ins>

Summary graphs





## Future implementations:

Include clinical data for deep Learning with mixed tabular and image data to try to understand the role of the micro-environmentfor the outcome of cancer patients.

## Image legend

### <ins>```model_name```_preds_summary_graph.png</ins>

After training the models, image batches generated by the train and val image generators were used to predict the os with the trained model and compared to the true os.
Summary graphs were plotted to observe the predicted os and mean absolute error accross all os labels

* 1st column, ```Target labels```: distribution of ```os``` labels seen during prediction for the training image generator and validation image generator.
* 2nd column, ```Predicted labels```: distribution of the ```os``` labels predicted by the model for the train image generator and validation image generator.
* 3rd column, ```Predictions vs true (train set)```: box plot of the predicted os's vs real os's for the train set.
* 4th column, ```Absolute error prediction vs true label (train set)``` : boxplot of the absolute errors between the predicted os and true os for the train set.
* 5th column, ```Predictions vs true (validation set)```: box plot of the predicted os's vs real os's for the validaion set.
* 6th column, ```Absolute error prediction vs true label (validation set)``` : boxplot of the absolute errors between the predicted os and true os for the validation set.

### <ins>IRNv2_training.png</ins>

Impact of transfer learning on InceptionResNetv2 prediction.
Top row corresponds to a model where only the prediction layer was trained. Model mainly predicts values around the mean os
Bottom row shows predictions generated by a model where 20% of the layers where freeed for training. Model manages to predict os that better fits the true data

### <ins>Train_mae_graph.png and Val_mae_graph.png</ins>

Mean Absolute Error was calculated for all trained models on train set and validation set predictions.
Those graphs display the lowest MAEs obtained over all trained models.
The blue line corresponds to the lowest MAE value, the solid red line to the MAE obtained by a dummy model predicting always the mean os.

### <ins>True_OS_vs_pred.png </ins>

Line plot showing the relation between the predicted OS and true OS for train and validation set with the best model (InceptionResNetv2 20% free layers) 